# 常用EEG MI数据集预处理
## 1. 对这些数据集的预处理方法
### 1.1. Left_Right Hand MI

1. 原始数据的预处理

   使用四阶巴特沃斯（Butter worth）滤波器，先进行0.5Hz的高通滤波，然后进行8-30Hz的带通滤波。其中，8-30Hz频段包含μ波（8-12Hz）和β波（13-30Hz），这两个波段通常用于运动想象相关分析。

   注意，先进行高通滤波，再进行带通滤波的意义：提升带通滤波的性能，更能精确提取。

2. 原始数据的实验内容

   包含噪声、休息状态、真实运动以及想象运动等。

3. 原始数据的通道

   包含64个EEG通道以及4个EMG通道。

4. 实验者数量：52

5. 采样率：512Hz

6. 我做的预处理

   删除所有与运动想象无关的通道，只保留左手和右手运动想象的数据。其中，区分左右手的数据，对应文件名`trial`字段，左手为01，右手为02。

   对于标记，只要是在运动想象过程中，那么标记就一直不是0；而原始数据集中，只有开始运动想象的一刹那，标记才不是0。使用不同的标记号区分不同的运动想象，下同。

### 1.2. Motor Movement_Imagery Dataset

1. 原始数据的预处理

   原文里没有说

2. 原始数据的实验内容

   对于每一个实验者，共有14次实验，其中第1、2次分别为睁眼和闭眼的噪声；第3-6次分别为：张开合上左/右拳头、想象张开合上左/右脚、同时张开和合上拳头或双脚、想象同时张开合上拳头或双脚；第7-10次、第11-14次都是对第3-6次实验的重复。

   原始数据以EDF+格式存储，在注释通道存储了每一个事件的发生时间和持续时间。其中，注释通道的`description`字段以T0、T1、T2（字符串）来描述事件：T0代表准备阶段；对于实验3、4、7、8、11、12，T1代表左拳，T2代表右拳；对于实验5、6、9、10、13、14，T1代表双拳，T2代表双脚。

3. 原始数据的通道

   包含64个EEG通道。

4. 实验者数量：109

5. 采样率：160Hz

6. 我做的预处理

   只保留第4、6、8、10、12、14次实验（都是与运动想象相关的）。同样地，我将标记数组也修改为只要是在想象中，那么标记就非0。

### 1.3. Grasp and Lift EEG Challenge

这个数据集不是MI任务，要不要放进来呢？

### 1.4. The largest SCP data of Motor-Imagery

1. 原始数据的预处理

   0.53-70Hz带通滤波、50Hz陷波滤波（用于避免市电干扰）

2. 原始数据的实验内容

   共有5种任务，对于每一个实验者，无需每一个任务都做：

   1. 想象5个手指（在实验者的惯用手上）的屈曲向上或向下，对应于原始数据集的5F任务
   2. 左右手想象（打开左拳/右拳/无操作），对应于原始数据集的CLA任务
   3. 多种运动想象（打开左拳/右拳/移动左腿/右腿/舌头发出声音/提示但无操作），对应于原始数据集的HaLT任务
   4. 手指放在键盘上，任何时刻自愿按下d或l键，左右手均可，对应于原始数据集的FREEFORM任务
   5. 屏幕上给出提示，但是无想象，对应于原始数据集的NoMT任务

   在原始数据的事件标记中，采用了不同的数字来对不同的事件进行标注，如下

   | 标志 | 5F任务         | 其他任务                 |
   | ---- | -------------- | ------------------------ |
   | 0    | 无事件         | （同上）                 |
   | 1    | 大拇指         | 左手                     |
   | 2    | 食指           | 右手                     |
   | 3    | 中指           | 屏幕上出现提示但是不想象 |
   | 4    | 无名指         | 左腿                     |
   | 5    | 小拇指         | 舌头发声                 |
   | 6    | -              | 右腿                     |
   | 91   | 会话之间的休息 | （同上）                 |
   | 92   | 试验结束       | （同上）                 |
   | 99   | 放松阶段       | （同上）                 |

3. 原始数据的通道

   21个EEG通道以及1个用于时钟信号同步的通道。

4. 实验者数量：13

5. 采样率：通常为200Hz。对于特殊的任务，存在1000Hz的采样率，在文件名中使用HFREQ标注，同时也可以在数据的`sampFreq`字段查看。

6. 我做的预处理

   删除最后一个同步通道。

   我对这些标记重新进行了映射，保证所有数据集对于事件都是统一的，对于91、92、99三个标志（甚至原始的数据集出现了错误，在一些文件中把91标成了90，92标成了91？），都统一视为0

7. 其他

   这篇文章中提到，区分左/右手、腿以及舌头的运动想象是最常见的MI范式，通常使用C3、C4、T3、T4和Cz这些电极（尤其是前两者）就能够很好的区分不同的运动想象。

### 1.5. BCI Competition IV-1

1. 原始数据的预处理

   低通滤波（10 阶切比雪夫 II 型滤波器，阻带波动 50dB，阻带边缘频率 49Hz）

2. 原始数据的实验内容

   对于每位实验者，从左手、右手和脚（左脚/右脚由实验者选择，也可以选择双脚）三个类别中选择了两种运动想象类别。

3. 原始数据的通道

   59个EEG通道

4. 实验者数量：7

5. 采样率：100Hz

6. 我做的预处理

   这个电极名称并不规范，有些电极名称甚至不在10-05标准系统之中，对于这些“非法”名称，做了以下处理：

   1. 对于名称为CFCx的电极（x代表某个数字，下同），观察电极映射位置后（这个数据集本身包含了电极在二维平面上展开投影，可以与真实电极的坐标映射进行对比）发现CFCx电极就是FCCx电极，把CFC5/3/1/2/4/6（通道号18-23）映射到FCC5/3/1/2/4/6上

   2. 实在找不到通道名称的包括

      1. 17：CFC7
      2. 24：CFC8
      3. 34：CCP7
      4. 41：CCP8

      对于这些通道，都删了

   此外，对于标记数组，也都展开成上面相同的格式。

### 1.6. BCI Competition IV-2a

1. 原始数据的预处理

   进行0.5-100Hz的带通滤波，以及50Hz的陷波滤波

2. 原始数据的实验内容

   包含4类任务：左手、右手、双脚、舌头的运动想象。

   对于每个受试者，包含两次会话，一次用作训练集数据，一次用作测试集数据。每次会话由3个噪声以及6次运行构成。其中三次噪声分别为：睁眼状态（2分钟）、闭眼状态（1分钟）、眼动状态（1分钟）；

   在每次运行中，都包含48次实验，每次实验的范式为：

   1. t=0：蜂鸣器响，屏幕上出现交叉点
   2. t=2：交叉点变为箭头提示，左右代表左右手，上代表舌头，下代表脚，开始想象，一直到t=6（相当于想象时长4s，但实际有效时间是3s，即从第3s开始到第6s是有效想象时间）
   3. t=6：结束想象，开始休息

   其中，对于不同的事件，使用了不同的编号进行表示，这种映射方式见下面

3. 原始数据的通道

   22个EEG通道和3个EOG通道

4. 实验者数量：9

5. 采样率：250Hz

6. 我做的预处理

   原始数据中，只有一些电极给出了名称（见原始论文里的图），我按照10-20标准系统的位置将剩下没标注出来的一一对应；此外，原始的GDF文件我发现用mne库无法正常读取，因此使用GitHub上：[bregydoc/bcidatasetIV2a](https://github.com/bregydoc/bcidatasetIV2a.git)，所给出的已经处理好的numpy格式数据。这份数据只是单纯的把原始数据改成了numpy格式，没有做任何其他处理，而我要做的工作是把这份数据处理成dataframe的形式。

   首先删除最后3个EOG通道，然后把事件的标注统一代码，并构造新的事件数组。

   | 原始代码 | 映射后的代码     | 事件            |
   | -------- | ---------------- | --------------- |
   | 276      | 0                | 空闲 睁眼       |
   | 277      | 0                | 空闲 闭眼       |
   | 768      | 0                | 一次trial的开始 |
   | 769      | Event.left_hand  | 左手            |
   | 770      | Event.right_hand | 右手            |
   | 771      | Event.foot       | 脚              |
   | 772      | Event.tongue     | 舌头            |
   | 783      | 0                | 未知            |
   | 1023     | 0                | 拒绝的实验      |
   | 1072     | 0                | 眼动            |
   | 32766    | 0                | 新运行的开始    |

   其中，对于测试集，虽然其中也做了一些标注，但是并没有有效的标签（指的是769-772），因此处理后测试集就没有事件通道。

### 1.7. BCI Competition IV-2b

1. 原始数据的预处理

   进行0.5-100Hz的带通滤波，以及50Hz的陷波滤波

2. 原始数据的实验内容

   对于每个受试者有5次会话。每次会话首先是检测眼电干扰，时长5分钟，与2a数据集的流程一样（其中B0102T与B0504E没有这一部分）；其次是6次运行，每次运行包含20次实验，也就是一次会话共计120次实验。

   对于不同的会话，实验范式也不同

   1. 01T、02T（无反馈）
      1. t=0：屏幕中出现交叉点
      2. t=2：蜂鸣器响70ms
      3. t=3：屏幕上出现左右箭头提示（代表左右手想象）
      4. t=4-7：想象阶段
      5. t=7：随机休息至少1.5s
   2. 03T、04E、05E
      1. t=0：屏幕中出现一个灰色笑脸
      2. t=2：蜂鸣器响70ms
      3. t=3：受试者通过提示，以及运动想象，将笑脸向左或向右移动，如果正确，则笑脸变成绿色，如果错误则变成红色哭脸
      4. t=4-7.5：有效的想象时间
      5. t=7.5：结束想象，开始休息

3. 原始数据的通道

   3个EEG通道，3个EOG通道

4. 实验者数量：9

5. 采样率：250Hz

6. 我做的预处理

   同2a数据集一样，也存在事件的映射，如下

   | 原始代码 | 映射后的代码     | 事件            |
   | -------- | ---------------- | --------------- |
   | 276      | 0                | 空闲 睁眼       |
   | 277      | 0                | 空闲 闭眼       |
   | 768      | 0                | 一次trial的开始 |
   | 769      | Event.left_hand  | 左手            |
   | 770      | Event.right_hand | 右手            |
   | 781      | 0                | BCI反馈         |
   | 783      | 0                | 未知            |
   | 1023     | 0                | 拒绝的实验      |
   | 1077     | 0                | 水平眼动        |
   | 1078     | 0                | 垂直眼动        |
   | 1079     | 0                | 眼珠转动        |
   | 1081     | 0                | 眨眼            |
   | 32766    | 0                | 新运行的开始    |

   实际上就是先区分不同的实验类型，其中对于1和2，想象时间从t=4-7，持续3s，也就是750帧；对于3、4、5，想象时间从t=4-7.5，持续3.5s，也就是875帧。

### 1.8. High-Gamma Dataset

1. 原始数据的预处理

   好像没做滤波，也没有降采样

2. 原始数据的实验内容

   四类：左手←、右手→、双脚↓、提示但不想象↑。每次想象时间为4s

3. 原始数据的通道

   1-32EEG+33-34EOG+35-37EMG+38-133EEG（85-88是FCCxh的重复，93-96也重复了，不知道为什么名字一样但是位置不一样，改成只取前面的）

4. 实验者数量：14

5. 采样率：500

6. 我做的预处理

   删除无关通道和重复的通道，将事件重新映射

## 2. 处理后的文件格式和数据结构

### 2.1. 文件格式

1. 运行完成后出现8个文件夹，对应于8个数据集，其中的文件均以`[dataset_id]_[person]_[trial]_[sampling_rate].parquet`命名

   1. dataset_id：同第一节所介绍的顺序，从01开始到08

   2. person：从1开始，为受试者的编号

   3. trial：通常是对一个受试者所进行的不同实验，不过在有些数据集中，这个字段代表了不同的含义，如表所示

      | 序号 | 数据集                                | trial字段含义                                |
      | ---- | ------------------------------------- | -------------------------------------------- |
      | 1    | Left_Right Hand MI                    | 01: 左手; 02:右手                            |
      | 2    | Motor Movement_Imagery Dataset        | 01/03/05: 左手/右手; 02/04/06: 双手/双脚     |
      | 3    | Grasp and Lift EEG Challenge          |                                              |
      | 4    | The largest SCP data of Motor-Imagery | 01:CLA; 02:HaLT; 03:5F; 04:FREEFORM; 05:NoMT |
      | 5    | BCI Competition IV-1                  | 01: 训练集; 02: 测试集（不含事件）           |
      | 6    | BCI Competition IV-2a                 | 01: 训练集; 02: 测试集（不含事件）           |
      | 7    | BCI Competition IV-2b                 | 01: 训练集; 02: 测试集（不含事件）           |
      | 8    | High-Gamma Dataset                    | 01: 训练集; 02: 测试集                       |

   4. sampling_rate：采样率

2. parquet文件是什么

   实际上每一个parquet就是一个pd.Dataframe数据类型，以一种压缩的形式存储，相比于csv节省了大量空间，在python中可以使用如下命令打开

   ```python
   import pandas as pd
   data = pd.read_parquet('01_01_01_512.parquet')
   ```

### 2.2. 数据结构

大多数文件（Dataframe）的最后一列都是事件标签，极少数文件除外（没有标签的，比如测试集），这一列的名称是`Event`。前面所有的列都是EEG信号，单位统一为mV，列名称就是符合10-05标准的通道名。

